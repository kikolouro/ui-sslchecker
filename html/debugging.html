<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificados SSL</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<script>
    var token;
    var id;
    if (window.XMLHttpRequest) {
        xmlhttp = new XMLHttpRequest();
    } else {
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange = () => {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            aux = JSON.parse(xmlhttp.responseText);
            token = aux.result
            id = aux.id

            if (window.XMLHttpRequest) {
                xmlhttp = new XMLHttpRequest();
            } else {
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = () => {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    aux = xmlhttp.responseText;
                    if (window.XMLHttpRequest) {
                        xmlhttp = new XMLHttpRequest();
                    } else {
                        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                    }
                    xmlhttp.onreadystatechange = () => {
                        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                            aux = xmlhttp.responseText;
                            window.location.replace("index.php");
                        }
                    }
                    xmlhttp.open("POST", "ZABBIX_SERVER_URL/zabbix/api_jsonrpc.php", true);
                    xmlhttp.setRequestHeader("Content-Type", "application/json")
                    xmlhttp.send(JSON.stringify({
                        "jsonrpc": "2.0",
                        "method": "trigger.create",
                        "params": [{
                            "description": "<?= $_REQUEST['newhost'] ?> falhou: {ITEM.VALUE}",
                            "expression": "{ZABBIX_SERVER_URL:web.test.error[<?= $_REQUEST['newhost'] ?>_cenario].strlen()}>0 and {ZABBIX_SERVER_URL:web.test.fail[<?= $_REQUEST['newhost'] ?>_cenario].last()}>0",
                            "priority": "5"

                        }, {
                            "description": "<?= $_REQUEST['newhost'] ?> está lento: {ITEM.VALUE}",
                            "expression": "{ZABBIX_SERVER_URL:web.test.in[<?= $_REQUEST['newhost'] ?>_cenario,,bps].last()}<500",
                            "priority": "5"

                        }],
                        "auth": token,
                        "id": id
                    }))
                }
            }
            xmlhttp.open("POST", "ZABBIX_SERVER_URL/zabbix/api_jsonrpc.php", true);
            xmlhttp.setRequestHeader("Content-Type", "application/json")
            xmlhttp.send(JSON.stringify({
                "jsonrpc": "2.0",
                "method": "httptest.create",
                "params": {
                    "name": "<?= $_REQUEST['newhost'] ?>_cenario",
                    "hostid": "10084",
                    "agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:73.0) Gecko/20100101 Firefox/73.0",
                    "steps": [{
                        "name": "<?= $_REQUEST['newhost'] ?>",
                        "url": "https://<?= $_REQUEST['newhost'] ?>/",
                        "status_codes": "200,201,210-299,302",
                        "no": 1
                    }]
                },
                "auth": token,
                "id": id
            }));
        }

    }

    xmlhttp.open("POST", "ZABBIX_SERVER_URL/zabbix/api_jsonrpc.php", true);
    xmlhttp.setRequestHeader("Content-Type", "application/json")
    xmlhttp.send(JSON.stringify({
        "jsonrpc": "2.0",
        "method": "user.login",
        "params": {
            "user": "ZABBIX_USER",
            "password": "ZABBIX_USER_PASSWORD"
        },
        "id": 1,
        "auth": null
    }));
</script>

<script>
    var token;
    var id;
    if (window.XMLHttpRequest) {
        xmlhttp = new XMLHttpRequest();
    } else {
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }

    xmlhttp.onreadystatechange = () => {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            aux = JSON.parse(xmlhttp.responseText);
            token = aux.result
            id = aux.id

            if (window.XMLHttpRequest) {
                xmlhttp = new XMLHttpRequest();
            } else {
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = () => {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    aux = JSON.parse(xmlhttp.responseText);
                    json = {
                        "jsonrpc": "2.0",
                        "method": "trigger.delete",
                    }
                    json.params = []
                    aux.result.forEach((self) => {
                        json.params.push(self.triggerid)
                    })
                    json.auth = token
                    json.id = id
                    if (window.XMLHttpRequest) {
                        xmlhttp = new XMLHttpRequest();
                    } else {
                        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                    }
                    xmlhttp.onreadystatechange = () => {
                        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                            aux = JSON.stringify(xmlhttp.responseText);
                            if (window.XMLHttpRequest) {
                                xmlhttp = new XMLHttpRequest();
                            } else {
                                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                            }
                            xmlhttp.onreadystatechange = () => {
                                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                                    aux = JSON.parse(xmlhttp.responseText);
                                    temp = aux.result[0].httptestid
                                    if (window.XMLHttpRequest) {
                                        xmlhttp = new XMLHttpRequest();
                                    } else {
                                        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                                    }
                                    xmlhttp.onreadystatechange = () => {
                                        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                                            window.location.replace("index.php");
                                        }
                                    }
                                    xmlhttp.open("POST", "ZABBIX_SERVER_URL/zabbix/api_jsonrpc.php", true);
                                    xmlhttp.setRequestHeader("Content-Type", "application/json")
                                    xmlhttp.send(JSON.stringify({
                                        "jsonrpc": "2.0",
                                        "method": "httptest.delete",
                                        "params": {
                                            "httptestid": temp
                                        },
                                        "auth": token,
                                        "id": id
                                    }));
                                }
                            }
                            xmlhttp.open("POST", "ZABBIX_SERVER_URL/zabbix/api_jsonrpc.php", true);
                            xmlhttp.setRequestHeader("Content-Type", "application/json")
                            xmlhttp.send(JSON.stringify({
                                "jsonrpc": "2.0",
                                "method": "httptest.get",
                                "params": {
                                    "output": [
                                        "httptestid"
                                    ],
                                    "selectFunctions": "extend",
                                    "filter": {
                                        "name": "<?= $host ?>_cenario"
                                    }
                                },
                                "auth": token,
                                "id": id
                            }));

                        }

                    }
                    xmlhttp.open("POST", "ZABBIX_SERVER_URL/zabbix/api_jsonrpc.php", true);
                    xmlhttp.setRequestHeader("Content-Type", "application/json")
                    xmlhttp.send(JSON.stringify(json));

                }
            }
            xmlhttp.open("POST", "ZABBIX_SERVER_URL/zabbix/api_jsonrpc.php", true);
            xmlhttp.setRequestHeader("Content-Type", "application/json")
            xmlhttp.send(JSON.stringify({
                "jsonrpc": "2.0",
                "method": "trigger.get",
                "params": {
                    "hostsid": "10084",
                    "output": [
                        "triggersid"
                    ],
                    "selectFunctions": "extend",
                    "filter": {
                        "description": [
                            "<?= $host ?> está lento: {ITEM.VALUE}",
                            "<?= $host ?> falhou: {ITEM.VALUE}"
                        ]
                    }
                },
                "auth": token,
                "id": id
            }));

        }
    }
    xmlhttp.open("POST", "ZABBIX_SERVER_URL/zabbix/api_jsonrpc.php", true);
    xmlhttp.setRequestHeader("Content-Type", "application/json")
    xmlhttp.send(JSON.stringify({
        "jsonrpc": "2.0",
        "method": "user.login",
        "params": {
            "user": "ZABBIX_USER",
            "password": "ZABBIX_USER_PASSWORD"
        },
        "id": 1,
        "auth": null
    }));
</script>




<header>
    <nav class="navbar navbar-dark bg-dark">
        <a class="navbar-brand" href="#">
            <img src="./images/logo-info-noslogan-web-neg.png" width="150" height="30" alt="">
          </a>
        <ul style:  class="nav">
            <li class="nav-item">
                <a  class="nav-link" href="./hosts.html">Hosts</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"  href="./newhosts.html">New Host</a>
            </li>
            <li class="nav-item active">
                <a  class="nav-link" href="./debugging.html">Debugging</a>
            </li>
          </ul>
        <ul style:  class="nav mx-auto">
            <li class="nav-item">
                <a class="nav-link" data-toggle="modal" data-target="#import" id="importbutton" href="#">Importar ficheiro de hosts</a>
            </li>
            <li class="nav-item">
                <a download="hosts" class="nav-link" href="hosts">Exportar ficheiro de hosts</a>
            </li>
          </ul>
            </ul>
      </nav>
</header>



<body class="content">



    <div class="container-fluid pt-xl-5" style="width: 80%; height: 80%;">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary" style="display:inline;">Central de Debugging</h6>  <button href="index.php?runscript" type="submit"  class="btn btn-success btn-sm float-right">Correr Script</button>
            </div>
            <div class="p-2">
                <h1 class="m-0 font-weight-bold" style="text-align: center;">Output</h1><br>
                <textarea class="form-control" rows="15" cols="50" id="textarea" readonly><?= $output ?></textarea>
            </div>

        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="import" tabindex="-1" role="dialog" aria-labelledby="import" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Arrasta o ficheiro novo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="index.php?import" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="file" name="file" class="form-control" />
                    </div>
                    <div class=" modal-footer">
                        <button type="button" class="btn btn-secondary active" data-dismiss="modal">Voltar
                            atrás</button>
                        <button type="submit" class="btn btn-danger">Importar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <script>
        $(document).ready(() => {
            $('.input-group-append').hide()
        })
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>

</html>